// Prisma Schema for Person Management System
// Simplified version focusing only on Person entity

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS - DEFINITIONS
// ============================================

/// Tipos de documento de identidad válidos en Perú
enum DocumentType {
  DNI       /// Documento Nacional de Identidad
  RUC       /// Registro Único de Contribuyentes
  CE        /// Carné de Extranjería
  PASSPORT  /// Pasaporte
}

/// Estados generales para entidades del sistema
enum EntityStatus {
  ACTIVE    /// Activo
  INACTIVE  /// Inactivo
  SUSPENDED /// Suspendido
  DELETED   /// Eliminado
}

/// Roles de usuario en el sistema
enum UserRole {
  ADMIN       /// Administrador
  SELLER      /// Vendedor
  WAREHOUSE   /// Almacén
  MANAGER     /// Gerente
}

/// Tipos de comprobantes de venta
enum VoucherType {
  RECEIPT     /// Boleta de venta
  INVOICE     /// Factura
  SALE_NOTE   /// Nota de venta
  PROFORMA    /// Proforma
}

/// Estados de SUNAT
enum SunatStatus {
  PENDING  /// Pendiente
  ACCEPTED /// Aceptado
  REJECTED /// Rechazado
  ERROR    /// Error
}

/// Ambientes de SUNAT
enum SunatEnvironment {
  PRODUCTION /// Producción
  TEST       /// Pruebas
}

/// Unidades de medida para productos
enum UnitOfMeasure {
  UNIT      /// Unidad
  KILOGRAM  /// Kilogramo
  LITER     /// Litro
  METER     /// Metro
  BOX       /// Caja
  PACK      /// Paquete
  DOZEN     /// Docena
}

/// Estados de compras
enum PurchaseStatus {
  PENDING    /// Pendiente
  REGISTERED /// Registrada
  CANCELLED  /// Cancelada
  RECEIVED   /// Recibida
}

/// Tipos de documentos de compra
enum PurchaseDocumentType {
  INVOICE /// Factura
  RECEIPT /// Recibo
  NOTE    /// Nota
  ORDER   /// Orden de compra
}

// ============================================
// MODELS - ENTITIES
// ============================================

/// Gestión de personas (clientes, proveedores, usuarios)
model Person {
  id              String   @id @default(uuid())
  documentType    DocumentType @map("document_type")
  documentNumber  String   @unique @map("document_number")
  names           String
  legalName       String?  @map("legal_name")
  address         String?
  phone           String?
  email           String?
  status          EntityStatus @default(ACTIVE)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  suppliers       Supplier[]
  customers       Customer[]
  users           User[]
  
  @@index([documentNumber])
  @@index([status])
  @@map("persons")
}

/// Gestión de tiendas/empresas
model Store {
  id                String   @id @default(uuid())
  businessName      String   @map("business_name")
  ruc               String   @unique
  legalName         String   @map("legal_name")
  address           String?
  phone             String?
  email             String?
  logoUrl           String?  @map("logo_url")
  status            EntityStatus @default(ACTIVE)
  registeredAt      DateTime @default(now()) @map("registered_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  users             User[]
  products          Product[]
  suppliers         Supplier[]
  purchases         Purchase[]
  customers         Customer[]
  //sales             Sale[]
  voucherSeries     VoucherSeries[]
  sunatConfig       SunatConfig?
  //cashRegisters     CashRegister[]

  @@index([status])
  @@map("stores")
}

/// Categorías de productos
model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relations
  products    Product[]

  @@index([status])
  @@map("categories")
}

/// Gestión de clientes
model Customer {
  id              String   @id @default(uuid())
  storeId         String   @map("store_id")
  personId        String   @map("person_id")
  status          EntityStatus @default(ACTIVE)
  registeredAt    DateTime @default(now()) @map("registered_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  store           Store    @relation(fields: [storeId], references: [id])
  person          Person   @relation(fields: [personId], references: [id])
  //sales           Sale[]

  @@index([status])
  @@map("customers")
}

/// Gestión de proveedores
model Supplier {
  id            String   @id @default(uuid())
  storeId       String   @map("store_id")
  personId      String   @map("person_id")
  status        EntityStatus @default(ACTIVE)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  store         Store    @relation(fields: [storeId], references: [id])
  person        Person   @relation(fields: [personId], references: [id])
  purchases     Purchase[]

  @@index([status])
  @@map("suppliers")
}

/// Gestión de usuarios del sistema
model User {
  id            String   @id @default(uuid())
  storeId       String   @map("store_id")
  personId      String   @map("person_id")
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          UserRole
  status        EntityStatus @default(ACTIVE)
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  store         Store    @relation(fields: [storeId], references: [id])
  person        Person   @relation(fields: [personId], references: [id])
  //sales         Sale[]
  purchases     Purchase[]
  //inventoryMovements InventoryMovement[]
  //cashRegisters CashRegister[]

  @@index([status])
  @@index([role])
  @@map("users")
}

/// Gestión de series de comprobantes
model VoucherSeries {
  id              String   @id @default(uuid())
  storeId         String   @map("store_id")
  voucherType     VoucherType @map("voucher_type")
  series          String
  currentNumber   Int      @default(1) @map("current_number")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  store           Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, voucherType, series])
  @@map("voucher_series")
}

/// Marcas de productos
model Brand {
  id        String   @id @default(uuid())
  name      String
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  products  Product[]

  @@index([status])
  @@map("brands")
}

/// Gestión de productos/inventario
model Product {
  id            String   @id @default(uuid())
  storeId       String   @map("store_id")
  categoryId    String?  @map("category_id")
  brandId       String?  @map("brand_id")
  sku           String   @unique @map("sku_code")
  name          String
  description   String?
  purchasePrice Float    @map("purchase_price")
  salePrice     Float    @map("sale_price")
  currentStock  Int      @default(0) @map("current_stock")
  reservedStock Int      @default(0) @map("reserved_stock")
  minimumStock  Int      @default(5) @map("minimum_stock")
  maximumStock  Int?     @map("maximum_stock")
  unitOfMeasure UnitOfMeasure @default(UNIT) @map("unit_of_measure")
  imageUrl      String?  @map("image_url")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  store         Store    @relation(fields: [storeId], references: [id])
  category      Category? @relation(fields: [categoryId], references: [id])
  brand         Brand?   @relation(fields: [brandId], references: [id])
  purchaseDetails PurchaseDetail[]
  //saleDetails   SaleDetail[]
  //inventoryMovements InventoryMovement[]

  // TODO: Implementar tabla InventoryMovement para registrar movimientos de stock
  // - Campos: id, productId, type (ENTRY/EXIT/ADJUSTMENT), quantity, previousStock, newStock
  // - Campos: reason, userId, createdAt, updatedAt
  // - Relaciones: product, user

  @@index([sku])
  @@index([isActive])
  @@index([storeId])
  @@map("products")
}

// ============================================
// PURCHASES AND PURCHASE DETAILS
// ============================================

/// Gestión de compras
model Purchase {
  id              String   @id @default(uuid())
  storeId         String   @map("store_id")
  supplierId      String   @map("supplier_id")
  userId          String   @map("user_id")
  documentNumber  String?  @map("document_number")
  documentType    PurchaseDocumentType @default(INVOICE) @map("document_type")
  purchaseDate    DateTime @map("purchase_date")
  subtotal        Float
  tax             Float    @default(0)
  discount        Float    @default(0)
  total           Float
  status          PurchaseStatus @default(REGISTERED)
  notes           String?
  registeredAt    DateTime @default(now()) @map("registered_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // Relations
  store           Store    @relation(fields: [storeId], references: [id])
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  user            User     @relation(fields: [userId], references: [id])
  details         PurchaseDetail[]

  @@index([status])
  @@index([purchaseDate])
  @@map("purchases")
}

/// Detalles de compras
model PurchaseDetail {
  id          String   @id @default(uuid())
  purchaseId  String   @map("purchase_id")
  productId   String   @map("product_id")
  quantity    Int
  unitPrice   Float    @map("unit_price")
  discount    Float    @default(0)
  
  // Relations
  purchase    Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@map("purchase_details")
}

/// Configuración de SUNAT
model SunatConfig { 
  id                  String   @id @default(uuid())
  storeId             String   @unique @map("store_id")
  solUsername         String   @map("sol_username")
  solPassword         String   @map("sol_password")
  digitalCertificate  Bytes?   @map("digital_certificate")
  certificatePassword String?  @map("certificate_password")
  apiUrl              String?  @map("sunat_api_url")
  environment         SunatEnvironment @default(TEST) @map("environment")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relations
  store               Store    @relation(fields: [storeId], references: [id])

  @@map("sunat_config")
}